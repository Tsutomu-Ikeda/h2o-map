<!DOCTYPE html>
<html lang="ja">

  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>tomtsutom.com | H2Oの適用範囲と所要時間の概算</title>

    <style>
      #map-wrapper {
        width: 90%;
        max-width: 1000px;
        float: left;
      }

      #shop-detail {
        margin-left: 50px;
        width: calc(100vw - min(90%, 1000px) - 100px);
        float: left;
      }
    </style>
  </head>

  <body>
    <h1>H2Oの適用範囲と所要時間の概算</h1>
    <div id="map-wrapper">
      <svg id="map" width="100%" height="100%" viewbox="0 0 800 400">
        <image href="./static/contourf.svg" x="800" y="800" width="2400" height="2400" opacity="0.9"/>
        <image href="./static/map.svg" x="0" y="0" width="4000" height="4000"/>
        <svg x="2800" y="2000" width="200" height="1000" viewbox="2000 0 400 2400">
          <image href="./static/colorbar.svg" x="0" y="0" width="2400" height="2400"/>
        </svg>
        <g id="shops"></g>
      </svg>
    </div>
    <div id="shop-detail"></div>
    <script>
      let viewBox = {
        x: 0,
        y: 0,
        width: 1000,
        height: 700,
        zoomRatio: 0
      };
      const maxZoomRatio = 180;
      const zoomParam = 1.008;
      let shops = [];
      const max = (ary) => (ary.reduce((a, b) => {
        return Math.max(a, b);
      }));
      const min = (ary) => (ary.reduce((a, b) => {
        return Math.min(a, b);
      }));

      const mapSvgElement = () => document.querySelector('#map');
      const mapWrapperElement = () => document.querySelector('#map-wrapper');
      const shopsElement = () => document.querySelector('#shops');
      const shopDetailElement = () => document.querySelector('#shop-detail');

      const updateViewBox = (viewBox) => {
        mapSvgElement().setAttribute("viewBox", `${viewBox.x} ${viewBox.y} ${viewBox.width * (zoomParam ** -viewBox.zoomRatio)} ${viewBox.height * (zoomParam ** -viewBox.zoomRatio)}`);
        localStorage.setItem("viewBox", JSON.stringify(viewBox))
      };

      const getHome = () => {
        return [35.662790903962346, 139.70905687170315];
      }

      const dispHome = () => {
        const previousViewBox = localStorage.getItem("viewBox");
        localStorage.setItem("viewBox", viewBox);
        if (previousViewBox) {
          viewBox = JSON.parse(previousViewBox);
        } else {
          const [cx, cy] = getPosition(...getHome());

          viewBox = {
            ...viewBox,
            x: cx - viewBox.width / 2,
            y: cy - viewBox.height / 2
          };
          localStorage.setItem("viewBox", JSON.stringify(viewBox));
        }

        updateViewBox(viewBox);
      };

      const getPosition = (lati, long) => {
        const center = [35.662790903962346, 139.70905687170315];
        const radius = 0.075;
        const [minLati, minLong] = [
            center[0] - radius,
            center[1] - radius / Math.cos(center[0] * Math.PI / 180)
          ],
          [maxLati, maxLong] = [
            center[0] + radius,
            center[1] + radius / Math.cos(center[0] * Math.PI / 180)
          ];
        const width = 4000,
          height = 4000;
        const x = (long - minLong) * width / (maxLong - minLong),
          y = (maxLati - lati) * height / (maxLati - minLati);

        return [x, y];
      };

      const createScrollHandler = (startViewBox, [startX, startY]) => ((ev) => {
        const dx = (ev.clientX - startX) * viewBox.width * (zoomParam ** -viewBox.zoomRatio) / mapWrapperElement().offsetWidth,
          dy = (ev.clientY - startY) * viewBox.height * (zoomParam ** -viewBox.zoomRatio) / mapWrapperElement().offsetHeight;
        viewBox = {
          ...viewBox,
          x: startViewBox.x - dx,
          y: startViewBox.y - dy
        }
        updateViewBox(viewBox)
      });

      const onScrollStart = (ev) => {
        mapSvgElement().onmousemove = createScrollHandler(viewBox, [ev.clientX, ev.clientY]);
      };

      const onScrollEnd = () => {
        mapSvgElement().onmousemove = null;
      };

      const onWheel = (ev) => {

        if (ev.ctrlKey) {
          ev.preventDefault();
          ev.stopImmediatePropagation();

          const getDZoomRatio = () => {
            if (Math.abs(viewBox.zoomRatio - ev.deltaY) < maxZoomRatio) {
              return -ev.deltaY;
            }

            if (viewBox.zoomRatio > 0) {
              return maxZoomRatio - viewBox.zoomRatio;
            } else {
              return -maxZoomRatio - viewBox.zoomRatio;
            }
          };

          const dZoomRatio = getDZoomRatio();

          const zoomPointX = ev.offsetX / mapWrapperElement().offsetWidth,
            zoomPointY = ev.offsetY / mapWrapperElement().offsetHeight;

          viewBox = {
            ...viewBox,
            x: viewBox.x - viewBox.width * (zoomParam ** -viewBox.zoomRatio) * (zoomParam ** -dZoomRatio - 1) * zoomPointX,
            y: viewBox.y - viewBox.height * (zoomParam ** -viewBox.zoomRatio) * (zoomParam ** -dZoomRatio - 1) * zoomPointY,
            zoomRatio: viewBox.zoomRatio + dZoomRatio
          }
          updateShops();
          updateViewBox(viewBox);
        } else if (ev.shiftKey) {

          ev.preventDefault();
          ev.stopImmediatePropagation();
          const dx = -ev.deltaY * viewBox.height / mapWrapperElement().offsetHeight;
          viewBox = {
            ...viewBox,
            x: viewBox.x - dx
          }
          updateViewBox(viewBox)
        } else {
          ev.preventDefault();
          ev.stopImmediatePropagation();
          const dx = -ev.deltaX * viewBox.width / mapWrapperElement().offsetWidth * (zoomParam ** -viewBox.zoomRatio),
            dy = -ev.deltaY * viewBox.height / mapWrapperElement().offsetHeight * (zoomParam ** -viewBox.zoomRatio);
          viewBox = {
            ...viewBox,
            x: viewBox.x - dx,
            y: viewBox.y - dy
          }
          updateViewBox(viewBox)
        }
      }

      const getColor = (shop) => {
        if (shop.type === "station") {
          return "#333";
        }
        if (!shop.costs) {
          return "gray";
        }
        const minute = min(shop.costs.map((cost) => cost.minute));

        if (minute <= 6) {
          return "#90ee90"; // lightgreen
        }
        if (minute <= 12) {
          return "#7fffd4"; // aquamarine
        }
        if (minute <= 18) {
          return "#00bfff" // deepskyblue
        }
        if (minute <= 24) {
          return "#ffff00" // yellow
        }
        if (minute <= 36) {
          return "#ffd700" // gold
        }
        if (minute <= 48) {
          return "#ffa500" // orange
        }
        return "red";
      };

      const getShopHTML = (shop) => {
        const [lati, long] = shop.coord;
        const [x, y] = getPosition(lati, long);
        if (shop.type === "station") {
          const width = height = 20 * (zoomParam ** -viewBox.zoomRatio);
          return `<image id="shop-${shop.id}" href="./static/train-24px.svg" width="${width}" height="${height}" x="${x - width / 2}" y="${y - height / 2}" />`
        } else {
          return `<circle id="shop-${shop.id}" cx="${x}" cy="${y}" r="${ 7 * Math.sqrt(zoomParam ** -viewBox.zoomRatio)}" fill="${getColor(shop)}" stroke="#333"/>`
        }
      }

      const updateShops = async () => {
        if (shops.length === 0) {
          const resp = await fetch("./data/shops.json");
          shops = await resp.json();
          console.log(shops.filter((item) => item.type === "station").map((item, index) => ({
            ...item,
            id: index + 1,
            costs: null
          })));
        }
        shopsElement().innerHTML = shops
          .sort((a, b) => {
            if (a.type === "station") {
              return 1;
            } else {
              return -1;
            }
          })
          .map((shop) => {
            return getShopHTML(shop);
          })
          .join("");

        const getCostHTML = (shop) => {
          if (!shop.costs) {
            return ""
          }
          const minute = min(shop.costs.map((cost) => cost.minute));
          return `<div>所要時間: ${minute}分</div>`
        }
        shops.forEach((shop) => {
          const shopElement = document.querySelector(`#shop-${shop.id}`);

          if (!shopElement) {
            return;
          }
          shopElement.onclick = () => {

            shopDetailElement().innerHTML = `
                <h3>${shop.name}</h3>
                ${getCostHTML(shop)}
                `;
          };
        });
      };

      updateShops();
      dispHome();

      mapSvgElement().style.cursor = "pointer";
      mapSvgElement().onmousedown = onScrollStart;

      mapSvgElement().onmousewheel = onWheel;
      window.onmouseup = onScrollEnd;

      document.onload = () => {
        document
          .querySelectorAll("svg image path")
          .forEach((item) => {
            console.log(item.id);
          });
      };
    </script>
  </body>

</html>
